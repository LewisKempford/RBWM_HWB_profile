---
params:
  save_params_as: "params.Rds"

  # Introduction
  title: TRUE
  introduction: TRUE
  summary: TRUE
  geographies: TRUE
  indicator_explained: TRUE

  # People and place
  title_people_and_place: TRUE
  population: TRUE
  deprivation: TRUE

  # Best start in life
  title_best_start_in_life: TRUE
  mmr: TRUE
  combined_dtap_ipv_hib: TRUE
  child_admissions: TRUE
  injury_admiss_under_5: TRUE
  injury_admiss_under_15: TRUE
  injury_admiss_15_to_24: TRUE
  reception_obesity: TRUE
  reception_overweight: TRUE
  year_6_obesity: TRUE
  year_6_overweight: TRUE
  qof_asthma: TRUE
  
  # Living well
  title_living_well: TRUE
  life_expectancy_females: TRUE
  life_expectancy_males: TRUE
  unemployment: TRUE
  long_term_unemployment: TRUE
  qof_learning_disability: TRUE
  qof_hypertension: TRUE
  qof_epilepsy: TRUE
  qof_diabetes: TRUE
  qof_copd: TRUE
  qof_hf: TRUE
  qof_chd: TRUE
  qof_cancer: TRUE
  qof_af: TRUE
  qof_mental_health: TRUE
  qof_depression: TRUE
  qof_smoking: TRUE
  qof_obesity: TRUE
  cervical_screening_25_49: TRUE
  cervical_screening_50_64: TRUE
  gp_caring_responsibility: TRUE
  emergency_admiss_all: TRUE
  emergency_admiss_chd: TRUE
  emergency_admiss_stroke: TRUE
  emergency_admiss_heart_attack: TRUE
  emergency_admiss_copd: TRUE
  emergency_admiss_self_harm: TRUE
  
  # Healthy ageing
  title_health_ageing: TRUE
  qof_stroke: TRUE
  qof_dementia: TRUE
  qof_ckd: TRUE
  qof_osteoporosis: TRUE
  qof_rheumatoid_arthritis: TRUE
  bowel_cancer_screening: TRUE
  breast_cancer_screening: TRUE
  emergency_admiss_hip_fracture: TRUE
  deaths_all_causes: TRUE
  deaths_under_75: TRUE
  deaths_preventable: TRUE
  deaths_cancer: TRUE
  deaths_cancer_under_75: TRUE
  deaths_circulatory_disease: TRUE
  deaths_circulatory_disease_under_75: TRUE
  deaths_chd: TRUE
  deaths_stroke: TRUE
  deaths_respiratory: TRUE
  
  # Healthy places
  title_healthy_place: TRUE
  healthy_place_signpost_slide: TRUE
  fuel_poverty: TRUE
  access_gardenspace: TRUE
  access_public_greenspace: TRUE
  access_secondary_school: TRUE
---

```{r settings}

# set working directory
setwd(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/projects_git/JHWBS_profiles/R"))

# Version number
version_num <- 0.64

# Load required packages
library(officer)
library(phiTools)
library(sf)
library(plyr)
library(openxlsx)

# Warning options
options(warn = 1) ## Show warnings as they occur, useful for finding and dealing with them.
options(scipen = 999) # Turn scientific notion off

# System time
t1 <- Sys.time()

# ---- PowerPoint template ----

# Open connection to pptx file
mydoc <- read_pptx(path = paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/References/Templates/RBWM_PHI_profiles_template.pptx"))

# slide number
slide_num <- 0

## Save the parameters in case we want to use them in a script
save_params_as <- params$save_params_as
saveRDS(params, file = save_params_as)

report_params <- params

## Choose which slides to include

# Introduction
incl_title <- report_params$title
incl_intro <- report_params$introduction
incl_summary <- report_params$summary
incl_geographies <- report_params$geographies
incl_indicator_explained <- report_params$indicator_explained

# People and place
incl_title_people_and_place<- report_params$title_people_and_place
incl_population <- report_params$population
incl_deprivation <- report_params$deprivation

# Best start in life
incl_title_best_start_in_life <- report_params$title_best_start_in_life
incl_mmr <- report_params$mmr
incl_combined_dtap_ipv_hib <- report_params$combined_dtap_ipv_hib
incl_child_admissions <- report_params$child_admissions
incl_injury_admiss_under_5 <- report_params$injury_admiss_under_5
incl_injury_admiss_under_15 <- report_params$injury_admiss_under_15
incl_injury_admiss_15_to_24 <- report_params$injury_admiss_15_to_24
incl_reception_obesity <- report_params$reception_obesity
incl_reception_overweight <- report_params$reception_overweight
incl_year_6_obesity <- report_params$year_6_obesity
incl_year_6_overweight <- report_params$year_6_overweight
incl_qof_asthma <- report_params$qof_asthma

# Living well
incl_title_living_well <- report_params$title_living_well
incl_life_expectancy_females <- report_params$life_expectancy_females
incl_life_expectancy_males <- report_params$life_expectancy_males
incl_unemployment <- report_params$unemployment
incl_long_term_unemployment <- report_params$long_term_unemployment
incl_qof_learning_disability <- report_params$qof_learning_disability
incl_qof_hypertension <- report_params$qof_hypertension
incl_qof_epilepsy <- report_params$qof_epilepsy
incl_qof_diabetes <- report_params$qof_diabetes
incl_qof_copd <- report_params$qof_copd
incl_qof_hf <- report_params$qof_hf
incl_qof_chd <- report_params$qof_chd
incl_qof_cancer <- report_params$qof_cancer
incl_qof_af <- report_params$qof_af
incl_qof_mental_health <- report_params$qof_mental_health
incl_qof_depression <- report_params$qof_depression
incl_qof_smoking <- report_params$qof_smoking
incl_qof_obesity <- report_params$qof_obesity
incl_cervical_screening_25_49 <- report_params$cervical_screening_25_49
incl_cervical_screening_50_64 <- report_params$cervical_screening_50_64
incl_gp_caring_responsibility <- report_params$gp_caring_responsibility
incl_emergency_admiss_all <- report_params$emergency_admiss_all
incl_emergency_admiss_chd <- report_params$emergency_admiss_chd
incl_emergency_admiss_stroke <- report_params$emergency_admiss_stroke
incl_emergency_admiss_heart_attack <- report_params$emergency_admiss_heart_attack
incl_emergency_admiss_copd <- report_params$emergency_admiss_copd
incl_emergency_admiss_self_harm <- report_params$emergency_admiss_self_harm

# Healthy ageing
incl_title_health_ageing <- report_params$title_health_ageing
incl_qof_stroke <- report_params$qof_stroke
incl_qof_dementia <- report_params$qof_dementia
incl_qof_ckd <- report_params$qof_ckd
incl_qof_osteoporosis <- report_params$qof_osteoporosis
incl_qof_rheumatoid_arthritis <- report_params$qof_rheumatoid_arthritis
incl_bowel_cancer_screening <- report_params$bowel_cancer_screening
incl_breast_cancer_screening <- report_params$breast_cancer_screening
incl_emergency_admiss_hip_fracture <- report_params$emergency_admiss_hip_fracture
incl_deaths_all_causes <- report_params$deaths_all_causes
incl_deaths_under_75 <- report_params$deaths_under_75
incl_deaths_preventable <- report_params$deaths_preventable
incl_deaths_cancer <- report_params$deaths_cancer
incl_deaths_cancer_under_75 <- report_params$deaths_cancer_under_75
incl_deaths_circulatory_disease <- report_params$deaths_circulatory_disease
incl_deaths_circulatory_disease_under_75 <- report_params$deaths_circulatory_disease_under_75
incl_deaths_chd <- report_params$deaths_chd
incl_deaths_stroke <- report_params$deaths_stroke
incl_deaths_respiratory <- report_params$deaths_respiratory

# Healthy place
incl_title_healthy_place <- report_params$title_healthy_place
incl_healthy_place_signpost_slide <- report_params$healthy_place_signpost_slide
incl_fuel_poverty <- report_params$fuel_poverty
incl_access_gardenspace <- report_params$access_gardenspace
incl_access_public_greenspace <- report_params$access_public_greenspace
incl_access_secondary_school <- report_params$access_secondary_school


# Create empty data frame for summary table
summary <- data.frame(indicator = character(), 
                      comparison = character(), 
                      slide = numeric(), stringsAsFactors = FALSE) 

#---- Geography lookups ----
rbwm_code <- "E06000040"
eng_code <- "E92000001"

# england and wales LSOA to ward to lad
lsoa_ward_lad <- read.csv(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/References/Geography/ONS Open Geography Portal/Lookups/LSOA to Ward to LAD/LSOA_(2021)_to_Electoral_Ward_(2024)_to_LAD_(2024)_Best_Fit_Lookup_in_EW.csv"))

# RBWM lsoas
i <- lsoa_ward_lad$LAD24CD == rbwm_code
rbwm_lsoas <- lsoa_ward_lad$LSOA21CD[i]

# 2011 LSOAs to ward
lsoa_ward_lad_2011 <- read.csv(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/References/Geography/ONS Open Geography Portal/Lookups/LSOA to Ward to LAD/LSOA11_WD20_LAD20_EW_LU_v2.csv"))

# RBWM postcodes
rbwm_pcodes <- readRDS(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/References/Geography/ONS Open Geography Portal/NSPL/processed_data/nspl_rbwm_postcodes.Rds"))

# rbwm wards
i <- lsoa_ward_lad$LAD24CD == rbwm_code
rbwm_wards <- unique(lsoa_ward_lad$WD24CD[i])

# England and Wales MSOA to ward to LAD
msoa_ward_lad <- read.csv(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/References/Geography/ONS Open Geography Portal/Lookups/MSOA to Ward to LAD/MSOA_(2021)_to_Ward_(2024)_to_LAD_(2024)_Best_Fit_Lookup_in_EW.csv"))

# RBWM MSOAs
i <- msoa_ward_lad$LAD24CD == rbwm_code
rbwm_msoas <- msoa_ward_lad$MSOA21CD[i]

# RBWM GPs
epraccur <- readRDS(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/Datasets/NHS Digital/GP and GP practice related data/processed_data/epraccur.Rds"))

rbwm_gp_codes <- merge(x = epraccur, y = rbwm_pcodes, by = "pcdNoSpaces")
rbwm_gp_codes <- rbwm_gp_codes$`Organisation Code`

#---- Shape files ----
#### LSOAs ####
shp_lsoa <- data_shape_lsoa()

# RBWM LSOAs
i <- shp_lsoa$AreaCode %in% rbwm_lsoas
shp_lsoa_rbwm <- shp_lsoa[i, ]

#### MSOAs ####
shp_msoa <- data_shape_msoa()

#### JHWBS profile dataset ####
folder_path <- paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/Datasets/Profiles/JHWBS profile/")
files <- list.files(folder_path)
files <- data.frame(FileName = files, 
                    Created = file.info(paste0(folder_path, files))$ctime)
files <- files[order(files$Created, decreasing = TRUE), ]

# read in data bundle
data_bundle <- readRDS(paste0(folder_path, files$FileName[1]))

# split data bundle into dataset and factor list
dataset <- data_bundle$dataset
factor_list <- data_bundle$factor_levels

```

```{r title, eval = incl_title}

slide_num <- slide_num + 1

# Add slide
mydoc <- add_slide(mydoc, layout = "title logo", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = paste0("The Royal Borough of Windsor \u0026 Maidenhead Health and Wellbeing profile"))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "subtitle"),
                 value = paste0("Public Health ", format(Sys.Date(), "%d/%m/%Y")))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r introduction, eval = incl_intro}

slide_num <- slide_num + 1

title <- paste0("Introduction")

text <- paste0("This profile provides a summary of the health and wellbeing of the population of the Royal Borough of Windsor and Maidenhead (RBWM).\nIt includes indicators that look across the life course of the population and includes demographic information, deprivation and health outcomes.\nIndicators have been grouped into five thematic areas: People and Place, Best Start in Life, Living Well, Healthy Ageing, and Healthy Place.\nThe profile was created to support the development of RBWM Joint Health and Wellbeing Strategy 2026-2036.")

# Add slide
mydoc <- add_slide(mydoc, layout = "title and content", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content"), 
                 value = text)
  
```

```{r summary, eval = incl_summary}

slide_num <- slide_num + 1

title <- paste0("Summary (1/2)")

text <- "This slide provides a summary of the indicators included in the profile compared to England for the local authority."

# Create summary tables
x <- summary_table_list(data = dataset)

# can only plot three tables per slide
tables <- x[1:3]

# Add slide
mydoc <- add_slide(mydoc, layout = "summary tables", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "text"),
                 value = text)

# Add each flextable at calculated position
for (i in seq_along(tables)) {
  # top_pos <- slide_height - 1.25
  location <- ph_location(left = 0.375 + ((i - 1) * 4.25), top = 1.9)
  my_doc <- ph_with(mydoc, location = location, value = tables[[i]])
}

```

```{r summary_2, eval = incl_summary}

slide_num <- slide_num + 1

title <- paste0("Summary (2/2)")

text <- "This slide provides a summary of the indicators included in the profile compared to England for the local authority."

# can only plot three tables per slide
tables <- x[4]

# Add slide
mydoc <- add_slide(mydoc, layout = "summary tables", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "text"),
                 value = text)

# Add each flextable at calculated position
for (i in seq_along(tables)) {
  # top_pos <- slide_height - 1.25
  location <- ph_location(left = 0.375 + ((i - 1) * 4.25), top = 1.9)
  my_doc <- ph_with(mydoc, location = location, value = tables[[i]])
}

```

```{r geographies, eval = incl_geographies}

slide_num <- slide_num + 1

title <- paste0("Statistical, Census and electoral geographies")

text <- unordered_list(
  level_list = c(0, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2),
  str_list = c(
    "Data at several small area levels are used in this profile, these include:", # level 0
    "Lower Super Output Areas (LSOAs)", # level 1
    paste0("LSOAs have a population size of 1,000 to 3,000 people.\nThere are ", length(rbwm_lsoas), " 2021 based LSOAs in RBWM."), # level 2
    "Middle Super Output Areas (MSOAs)", # level 1
    paste0("MSOAs have a population size of 5,000 to 15,000 people.\nThere are ", length(rbwm_msoas), " 2021 based LSOAs in RBWM."), # level 2
    "Electoral Wards", # level 1
    paste0("An electoral ward is an area from which one or more councillors are elected to represent residents on the local council.\nThere are ", length(rbwm_wards), " wards in RBWM."), # level 2
    "Postcodes", # level 1
    paste0("Postcodes are used to identify specific locations within the borough.\nThere are ", nrow(rbwm_pcodes), " postcodes in RBWM."), # level 2
    "GP practices", # level 1
    paste0("This profile shows main GP practices in the borough.\nThere are ", length(rbwm_gp_codes), " GP practices in RBWM.") # level 2
               ),
  style = list(
    fp_text(font.size = 20),
    fp_text(font.size = 16),
    fp_text(font.size = 14),
    fp_text(font.size = 16),
    fp_text(font.size = 14),
    fp_text(font.size = 16),
    fp_text(font.size = 14),
    fp_text(font.size = 16),
    fp_text(font.size = 14),
    fp_text(font.size = 16),
    fp_text(font.size = 14) 
    )
  )

# Add slide
mydoc <- add_slide(mydoc, layout = "title and content", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content"), 
                 value = text)
  
```

```{r indicator_explained, eval = incl_indicator_explained}

slide_num <- slide_num + 1

title <- paste0("Indicators explained")

# Add slide
mydoc <- add_slide(mydoc, layout = "JHWBS indicator explained", 
                   master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))

```

```{r title_people_and_place, eval = incl_title_people_and_place}

# ---- People and place ----
slide_num <- slide_num + 1

title <- paste0("People and place")
short_title <- NULL

# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r population, eval = incl_population}

slide_num <- slide_num + 1

# Metadata
ind_ID <- "LApe"
ind_sex <- "Persons"
ind_age <- NULL
title <- paste0("Population")
short_title <- NULL
context <- NULL
value_type <- NULL
value_type_short <- NULL
timeperiod <- NULL
original_geography <- NULL
CI_level <- NULL
benchmarking_method <- NULL
source <- NULL
caveats <- NULL
notes <- NULL


x <- dataset[dataset$IndicatorID == ind_ID, ]

# Outputs
pop_pyramid <- plot_pop_pyramid(data = x)
pop_comp <- plot_pop_area_comp_eng(data = x)

# Add slide
mydoc <- add_slide(mydoc, layout = "two content", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content left"), 
                 value = pop_pyramid$plot, alt_text = pop_pyramid$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content right"), 
                 value = pop_comp$plot, alt_text = pop_comp$alt_text)

```

```{r deprivation, eval = incl_deprivation}

slide_num <- slide_num + 1

# Metadata
ind_ID <- "IMD"
ind_sex <- "persons"
ind_age <- NULL
title <- paste0("Deprivation")
short_title <- NULL
context <- NULL
value_type <- NULL
value_type_short <- NULL
timeperiod <- NULL
original_geography <- NULL
CI_level <- NULL
benchmarking_method <- NULL
source <- NULL
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

# Outputs
pop_dep_bar_plot <- plot_dep_pop(data = x)
dep_map <- map_deprivation(deprivation_data = x, lsoa_shape = shp_lsoa,
                           lsoas_to_plot = rbwm_lsoas)

# Add slide
mydoc <- add_slide(mydoc, layout = "two content", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content left"), 
                 value = pop_dep_bar_plot$plot, alt_text = pop_dep_bar_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content right"), 
                 value = dep_map$plot, alt_text = dep_map$alt_text)

```

```{r title_best_start_in_life, eval = incl_title_best_start_in_life}

# ---- Best start in life ----
slide_num <- slide_num + 1

title <- paste0("Best start in life")
short_title <- NULL

# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r mmr, eval = incl_mmr}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 92781
ind_sex <- "Persons"
ind_age <- "2 yrs"
title <- paste0("MMR vaccination for one dose - registered population (",
                tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("MMR vaccination for one dose (", (ind_age), ")")

context <- paste0("MMR is the combined vaccine that protects against measles, mumps and rubella. The Department of Health have adopted the World Health Organisation's 95% target for vaccination coverage at national and local levels")
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

# latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r combined_dtap_ipv_hib, eval = incl_combined_dtap_ipv_hib}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 92782
ind_sex <- "Persons"
ind_age <- "2 yrs"
title <- paste0("Dtap/ IPV/ Hib vaccination - registered population (",
                tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Dtap/ IPV/ Hib vaccination (", ind_age, ")")

context <- paste0("The combined DTaP/IPV/Hib is the first in a course of vaccines offered to babies to protect them against diphtheria, pertussis (whooping cough), tetanus, Haemophilus influenzae type b and polio. The Department of Health have adopted the World Health Organisation's 95% target for vaccination coverage at national and local levels")
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

# latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)

# gotta make font size smaller as too much metadata
formatted_metadata <- fpar(ftext(metadata, prop = fp_text(font.size = 8)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = formatted_metadata)

```

```{r child_admissions, eval = incl_child_admissions}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93115
ind_sex <- "Persons"
ind_age <- "Under 5 yrs"
title <- paste0("Emergency hospital admissions, ", tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions (", tolower(ind_age), ")")
context <- NULL
value_type <- "Crude rate per 1,000"
value_type_short <- "per 1,000"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r injury_admiss_under_5, eval = incl_injury_admiss_under_5}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93114
ind_sex <- "Persons"
ind_age <- "Under 5 yrs"
title <- paste0("Emergency hospital admissions for injuries, ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for injuries (", tolower(ind_age),
                      ")")
context <- NULL
value_type <- "Crude rate per 1,000"
value_type_short <- "per 1,000"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                             show_comp_legend = FALSE, 
                             timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r injury_admiss_under_15, eval = incl_injury_admiss_under_15}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93219
ind_sex <- "Persons"
ind_age <- "Under 15 yrs"
title <- paste0("Emergency hospital admissions for injuries, ", 
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for injuries (", tolower(ind_age), ")")
context <- NULL
value_type <- "Crude rate per 1,000"
value_type_short <- "per 1,000"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)


# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r injury_admiss_15_to_24, eval = incl_injury_admiss_15_to_24}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93224
ind_sex <- "Persons"
ind_age <- "15 to 24 yrs"
title <- paste0("Emergency hospital admissions for injuries, ", 
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for injuries (", ind_age, ")")
context <- NULL
value_type <- "Crude rate per 1,000"
value_type_short <- "per 1,000"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r reception_obesity, eval = incl_reception_obesity}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93105
ind_sex <- "Persons"
ind_age <- "4-5 yrs"
title <- paste0("Reception: Prevalence of obesity (including severe obesity), ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Reception: Prevalence of obesity (", ind_age, ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score CI method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Data for local authorities may not match that published by NHS England which are based on the local authority of the school attended by the child or based on the local authority that submitted the data")
notes <- "Due to the impact of COVID-19 on the NCMP data collection, data was not published for the 2018/19 - 20/21 time period"

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = "Proportion (%)")
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
# gotta make font size smaller as too much metadata
formatted_metadata <- fpar(ftext(metadata, prop = fp_text(font.size = 8)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = formatted_metadata)

```

```{r reception_overweight, eval = incl_reception_overweight}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93106
ind_sex <- "Persons"
ind_age <- "4-5 yrs"
title <- paste0("Reception: Prevalence of overweight (including obesity), ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Reception: Prevalence of overweight (", ind_age, ")")
additional_text <- "Overweight: including obesity\n\n"
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score CI method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- "Data for local authorities may not match that published by NHS England which are based on the local authority of the school attended by the child or based on the local authority that submitted the data"
notes <- "Due to the impact of COVID-19 on the NCMP data collection, data was not published for the 2018/19-20/21 time period"

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = "Proportion (%)")
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
# gotta make font size smaller as too much metadata
formatted_metadata <- fpar(ftext(metadata, prop = fp_text(font.size = 8)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = formatted_metadata)

```

```{r year_6_obesity, eval = incl_year_6_obesity}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93107
ind_sex <- "Persons"
ind_age <- "10-11 yrs"
title <- paste0("Year 6: Prevalence of obesity (including severe obesity), ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Year 6: Prevalence of obesity (", ind_age, ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score CI method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- "Data for local authorities may not match that published by NHS England which are based on the local authority of the school attended by the child or based on the local authority that submitted the data"
notes <- "Due to the impact of COVID-19 on the NCMP data collection, data was not published for the 2018/19-20/21 time period"

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = "Proportion (%)")
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
# gotta make font size smaller as too much metadata
formatted_metadata <- fpar(ftext(metadata, prop = fp_text(font.size = 8)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = formatted_metadata) 

```

```{r year_6_overweight, eval = incl_year_6_overweight}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93108
ind_sex <- "Persons"
ind_age <- "10-11 yrs"
title <- paste0("Year 6: Prevalence of overweight (including obesity), ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Year 6: Prevalence of overweight (", ind_age, ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score CI method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- "Data for local authorities may not match that published by NHS England which are based on the local authority of the school attended by the child or based on the local authority that submitted the data"
notes <- "Due to the impact of COVID-19 on the NCMP data collection, data was not published for the 2018/19-20/21 time period"

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = "Proportion (%)")
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
# gotta make font size smaller as too much metadata
formatted_metadata <- fpar(ftext(metadata, prop = fp_text(font.size = 8)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = formatted_metadata)

```

```{r qof_asthma, eval = incl_qof_asthma}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 90933
ind_sex <- "Persons"
ind_age <- "6+ yrs"
title <- paste0("Asthma: QOF prevalence (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Asthma: QOF prevalence (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r title_living_well, eval = incl_title_living_well}

# ---- Living well ----
slide_num <- slide_num + 1

title <- paste0("Living well")
short_title <- NULL

# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r life_expectancy_females, eval = incl_life_expectancy_females}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93283
ind_sex <- "Female"
ind_age <- NULL
title <- paste0("Life expectancy at birth, upper age band 90 and over (",
                tolower(ind_sex), ")")
short_title <- paste0("Life expectancy at birth (", tolower(ind_sex), ")")
context <- NULL
value_type <- "Life expectancy (years)"
value_type_short <- "Years"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Chiang CL (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)
x <- x[x$Sex == ind_sex, ]

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r life_expectancy_males, eval = incl_life_expectancy_males}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93283
ind_sex <- "Male"
ind_age <- NULL
title <- paste0("Life expectancy at birth, upper age band 90 and over (",
                tolower(ind_sex), ")")
short_title <- paste0("Life expectancy at birth (", tolower(ind_sex), ")")
context <- NULL
value_type <- "Life expectancy (years)"
value_type_short <- "Years"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Chiang CL (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)
x <- x[x$Sex == ind_sex, ]

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r unemployment, eval = incl_unemployment}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93097
ind_sex <- "Persons"
ind_age <- "16-64 yrs"
title <- paste0("Unemployment (Percentage of the working age population claiming out of work benefit) (",
                tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Unemployment (", ind_age, ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score CI method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r long_term_unemployment, eval = incl_long_term_unemployment}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93098
ind_sex <- "Persons"
ind_age <- "16-64 yrs"
title <- paste0("Long-Term Unemployment (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Long-Term Unemployment (", ind_age, ")")
context <- NULL
value_type <- "Crude rate per 1,000"
value_type_short <- "per 1,000"
timeperiod <- "financial years"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Jobseekers Allowance datasets only cover a subset of people claiming unemployment related benefits")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_learning_disability, eval = incl_qof_learning_disability}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 200
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Learning disability: QOF prevalence (", tolower(ind_sex),
                "), (", tolower(ind_age), ")")
short_title <- paste0("Learning disability: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_hypertension, eval = incl_qof_hypertension}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 219
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Hypertension: QOF prevalence (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Hypertension: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_epilepsy, eval = incl_qof_epilepsy}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 224
ind_sex <- "Persons"
ind_age <- "18+ yrs"
title <- paste0("Epilepsy: QOF prevalence (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Epilepsy: QOF prevalence (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

#latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_diabetes, eval = incl_qof_diabetes}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 241
ind_sex <- "Persons"
ind_age <- "17+ yrs"
title <- paste0("Diabetes: QOF prevalence (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Diabetes: QOF prevalence (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r qof_copd, eval = incl_qof_copd}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 253
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Chronic Obstructive Pulmonary Disease: QOF prevalence (",
                tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("COPD: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r qof_hf, eval = incl_qof_hf}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 262
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Heart Failure: QOF prevalence (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Heart Failure: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r qof_chd, eval = incl_qof_chd}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 273
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Coronary heart disease: QOF prevalence (", tolower(ind_sex),
                "), (", tolower(ind_age), ")")
short_title <- paste0("CHD: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r qof_cancer, eval = incl_qof_cancer}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 276
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Cancer: QOF prevalence (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Cancer: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

#latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_af, eval = incl_qof_af}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 280
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Atrial fibrillation: QOF prevalence (", tolower(ind_sex),
                "), (", tolower(ind_age), ")")
short_title <- paste0("Atrial fibrillation: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r qof_mental_health, eval = incl_qof_mental_health}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 90581
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Mental Health: QOF prevalence (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Mental Health: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r qof_depression, eval = incl_qof_depression}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 90646
ind_sex <- "Persons"
ind_age <- "18+ yrs"
title <- paste0("Depression: QOF incidence - new diagnosis (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Depression: QOF incidence (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r qof_smoking, eval = incl_qof_smoking}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 91280
ind_sex <- "Persons"
ind_age <- "15+ yrs"
title <- paste0("Smoking: QOF prevalence (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Smoking: QOF prevalence (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

# latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_obesity, eval = incl_qof_obesity}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 94136
ind_sex <- "Persons"
ind_age <- "18+ yrs"
title <- paste0("Obesity: QOF prevalence (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Obesity: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r cervical_screening_25_49, eval = incl_cervical_screening_25_49}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93725
ind_sex <- "Female"
ind_age <- "25-49 yrs"
title <- paste0("Cervical screening coverage (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Cervical screening coverage (", tolower(ind_sex), ") (", 
                      tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

# latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r cervical_screening_50_64, eval = incl_cervical_screening_50_64}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93726
ind_sex <- "Female"
ind_age <- "50-64 yrs"
title <- paste0("Cervical screening coverage (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Cervical screening coverage (", tolower(ind_sex), ") (", 
                      tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

# latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r gp_caring_responsibility, eval = incl_gp_caring_responsibility}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 352
ind_sex <- "Persons"
ind_age <- "16+ yrs"
title <- paste0("% with caring responsibility (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("% with caring responsibility (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- NULL
benchmarking_method <- paste0("Quintiles created using sample quantiles, where quintile 1 is the worst performing")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- paste0("All results are based on weighted data. Weighting changes the data to account for differences between all patients at a practice and the sub-set of patients who actually take part in the survey")

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

#latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_quint(data = x, value_type = value_type, 
                                  area_codes = rbwm_gp_codes,
                                  show_ci = FALSE)
map <- map_quint_locations(data = x, shape_file = shp_lsoa_rbwm, 
                           locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
# gotta make font size smaller as too much metadata
formatted_metadata <- fpar(ftext(metadata, prop = fp_text(font.size = 8)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = formatted_metadata) 

```

```{r emergency_admiss_all, eval = incl_emergency_admiss_all}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93227
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Emergency hospital admissions for all causes, ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for all causes")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r emergency_admiss_chd, eval = incl_emergency_admiss_chd}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93229
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("EEmergency hospital admissions for coronary heart disease, ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for CHD")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r emergency_admiss_stroke, eval = incl_emergency_admiss_stroke}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93231
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Emergency hospital admissions for stroke, ", tolower(ind_sex),
                ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for stroke")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r emergency_admiss_heart_attack, eval = incl_emergency_admiss_heart_attack}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93232
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Emergency hospital admissions for myocardial infarction (heart attack), ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for heart attack")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r emergency_admiss_copd, eval = incl_emergency_admiss_copd}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93233
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Emergency hospital admissions for chronic obstructive pulmonary disease (COPD), ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for COPD")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r emergency_admiss_self_harm, eval = incl_emergency_admiss_self_harm}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93239
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Emergency hospital admissions for intentional self harm, ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for self harm")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r title_health_ageing, eval = incl_title_health_ageing}

# ---- Healthy ageing ----
slide_num <- slide_num + 1

title <- paste0("Healthy ageing")
short_title <- NULL

# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r qof_stroke, eval = incl_qof_stroke}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 212
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Stroke: QOF prevalence (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Stroke: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
confidence_interval_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_dementia, eval = incl_qof_dementia}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 247
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Dementia: QOF prevalence (", tolower(ind_sex), "), (", tolower(ind_age), ")")
short_title <- paste0("Dementia: QOF prevalence")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
confidence_interval_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_ckd, eval = incl_qof_ckd}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 258
ind_sex <- "Persons"
ind_age <- "18+ yrs"
title <- paste0("Chronic Kidney Disease: QOF prevalence (", tolower(ind_sex), 
                "), (", tolower(ind_age), ")")
short_title <- paste0("CKD: QOF prevalence (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_osteoporosis, eval = incl_qof_osteoporosis}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 90443
ind_sex <- "Persons"
ind_age <- "50+ yrs"
title <- paste0("Osteoporosis: QOF prevalence (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Osteoporosis: QOF prevalence (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r qof_rheumatoid_arthritis, eval = incl_qof_rheumatoid_arthritis}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 91269
ind_sex <- "Persons"
ind_age <- "16+ yrs"
title <- paste0("Rheumatoid arthritis: QOF prevalence (", tolower(ind_sex),
                "), (", tolower(ind_age), ")")
short_title <- paste0("Rheumatoid arthritis: QOF prevalence (",
                      tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- paste0("Local authority values are calculated by assigning all patients of the GP practice to the local authority where the GP practice is located")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r bowel_cancer_screening, eval = incl_bowel_cancer_screening}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 92600
ind_sex <- "Persons"
ind_age <- "60-74 yrs"
title <- paste0("Bowel cancer screening coverage (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Bowel cancer screening (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

#latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r breast_cancer_screening, eval = incl_breast_cancer_screening}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 94063
ind_sex <- "Persons"
ind_age <- "53-70 yrs"
title <- paste0("Breast screening coverage (", tolower(ind_sex), "), (",
                tolower(ind_age), ")")
short_title <- paste0("Breast screening (", tolower(ind_age), ")")
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- "financial years"
original_geography <- "GP"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

#latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
# trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
#                                    show_comp_legend = FALSE, 
#                                    timeperiod_format = timeperiod)
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_gp_codes,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_locations(data = x, shape_file = shp_lsoa_rbwm, 
                          locations_to_map = rbwm_gp_codes)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

unavailable_note <- paste0("Data unavailable for counties & UAs")

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = unavailable_note)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r emergency_admiss_hip_fracture, eval = incl_emergency_admiss_hip_fracture}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93241
ind_sex <- "Persons"
ind_age <- "65 yrs+"
title <- paste0("Emergency hospital admissions for hip fracture, ",
                tolower(ind_sex), ", ", tolower(ind_age))
short_title <- paste0("Emergency admissions for hip fracture (", ind_age, ")")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_all_causes, eval = incl_deaths_all_causes}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93250
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Deaths from all causes, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from all causes")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_under_75, eval = incl_deaths_under_75}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93252
ind_sex <- "Persons"
ind_age <- "Under 75 yrs"
title <- paste0("Deaths from all causes, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from all causes (", tolower(ind_age), ")")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_preventable, eval = incl_deaths_preventable}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93480
ind_sex <- "Persons"
ind_age <- "Under 75 yrs"
title <- paste0("Deaths from causes considered preventable, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from preventable causes (", tolower(ind_age), ")")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_cancer, eval = incl_deaths_cancer}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93253
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Deaths from all cancer, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from all cancer")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_cancer_under_75, eval = incl_deaths_cancer_under_75}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93254
ind_sex <- "Persons"
ind_age <- "Under 75 yrs"
title <- paste0("Deaths from all cancer, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from all cancer (", tolower(ind_age), ")")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_circulatory_disease, eval = incl_deaths_circulatory_disease}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93255
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Deaths from circulatory disease, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from circulatory disease")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_circulatory_disease_under_75, eval = incl_deaths_circulatory_disease_under_75}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93256
ind_sex <- "Persons"
ind_age <- "Under 75 yrs"
title <- paste0("Deaths from circulatory disease, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from circulatory disease (", tolower(ind_age), ")")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_chd, eval = incl_deaths_chd}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93257
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Deaths from coronary heart disease, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from CHD")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_stroke, eval = incl_deaths_stroke}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93259
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Deaths from stroke, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from stroke")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r deaths_respiratory, eval = incl_deaths_respiratory}

slide_num <- slide_num + 1

# Metadata
ind_ID <- 93260
ind_sex <- "Persons"
ind_age <- "All ages"
title <- paste0("Deaths from respiratory diseases, ", tolower(ind_sex), ", ",
                tolower(ind_age))
short_title <- paste0("Deaths from respiratory diseases")
context <- NULL
value_type <- "Indirectly standardised ratio"
value_type_short <- "per 100"
timeperiod <- "periods"
original_geography <- "MSOA"
CI_level <- 0.95
benchmarking_method <- paste0("Byar's method method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
trend_plot <- plot_trend_rag(data = x, value_type = value_type, 
                                   show_comp_legend = FALSE, 
                                   timeperiod_format = "periods")
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_msoas,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_msoa, 
                         areas_to_map = rbwm_msoas)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r title_healthy_place, eval = incl_title_healthy_place}

# ---- Healthy place ----
slide_num <- slide_num + 1

title <- paste0("Healthy place")
short_title <- NULL


# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r healthy_place_signpost_slide, eval = incl_healthy_place_signpost_slide}

slide_num <- slide_num + 1

title <- paste0("Healthy place indicator signpost")
short_title <- NULL

# font size
size <- fp_text(font.size = 18 )

# Define multiple links
housing_condition <- hyperlink_ftext("English Housing Survey. Ministry of Housing, Communities and Local Government.", href = "https://www.gov.uk/government/statistics/english-housing-survey-local-authority-housing-stock-condition-modelling-2023",
                                     prop = size)
housing_efficiency <- hyperlink_ftext("Energy efficiency of housing. Nomis.", 
                                      href = "https://www.nomisweb.co.uk/datasets/eeh",
                                      prop = size)
housing_maps <- hyperlink_ftext("Housing Census maps. ONS.", 
                                href = "https://www.ons.gov.uk/census/maps/choropleth/housing?lad=E06000040",
                                prop = size)
work_maps <- hyperlink_ftext("Work Census maps. ONS.", 
                             href = "https://www.ons.gov.uk/census/maps/choropleth/work?lad=E06000040",
                             prop = size)

# Combine them into a formatted paragraph
bullet_list <- block_list(fpar(housing_condition), fpar(housing_efficiency),
                          fpar(housing_maps), fpar(work_maps))


# Add slide
mydoc <- add_slide(mydoc, layout = "title and content", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content"), 
                 value = bullet_list)
  
```

```{r fuel_poverty, eval = incl_fuel_poverty}

slide_num <- slide_num + 1

# Metadata
ind_ID <- "FlPv"
ind_sex <- NULL
ind_age <- NULL
title <- paste0("Fuel poverty measured as low income low energy efficiency (LILEE)")
short_title <- paste0("Fuel poverty")
context <- NULL
value_type <- "Proportion (%) - Households"
value_type_short <- "Proportion (%)"
timeperiod <- NULL
original_geography <- "LSOA"
CI_level <- NULL
benchmarking_method <- paste0("Quintiles created using sample quantiles, where quintile 1 is the worst performing")
source <- paste0("Department for Energy Security and Net Zero. Sub-regional fuel poverty data")
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_quint(data = x, value_type = value_type_short)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
area_comp <- plot_areas_quint(data = x, area_codes = rbwm_wards,
                                  value_type = value_type_short,
                                  show_ci = FALSE)
map <- map_quintile_indicator(data = x, shape_file = shp_lsoa, 
                              areas_to_map = rbwm_lsoas)
trend_plot <- plot_trend_quint(data = x, show_comp_legend = FALSE)

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot$plot, alt_text = trend_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata)

```

```{r access_gardenspace, eval = incl_access_gardenspace}

slide_num <- slide_num + 1

# Metadata
ind_ID <- "Accsstgrdn"
ind_sex <- NULL
ind_age <- NULL
title <- paste0("Access to garden space")
short_title <- paste0("Access to garden space")
context <- NULL
value_type <- "Proportion (%) - Addresses"
value_type_short <- "Proportion (%)"
timeperiod <- NULL
original_geography <- "MSOA"
CI_level <- NULL
benchmarking_method <- paste0("Quintiles created using sample quantiles, where quintile 1 is the worst performing")
source <- paste0("Office for National Statistics. Access to gardens and public green space in Great Britain")
caveats <- NULL
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_quint(data = x, value_type = value_type_short)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
area_comp <- plot_areas_quint(data = x, area_codes = rbwm_msoas,
                                  value_type = value_type_short,
                                  show_ci = FALSE)
map <- map_quintile_indicator(data = x, shape_file = shp_msoa, 
                              areas_to_map = rbwm_msoas)
trend_plot <- paste0("No trend data available.")

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot, alt_text = trend_plot)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

```{r access_public_greenspace, eval = incl_access_public_greenspace}

slide_num <- slide_num + 1

# Metadata
ind_ID <- "Accsstgrns"
ind_sex <- NULL
ind_age <- NULL
title <- paste0("Access to public green space (within a five-minute walk)")
short_title <- paste0("Access to public green space")
context <- NULL
value_type <- "Proportion (%) - Addresses"
value_type_short <- "Proportion (%)"
timeperiod <- NULL
original_geography <- "Postcode"
CI_level <- NULL
benchmarking_method <- paste0("Quintiles created using sample quantiles, where quintile 1 is the worst performing")
source <- paste0("Office for National Statistics. Access to gardens and public green space in Great Britain")
caveats <- paste0("Public green space access indicator is restricted to built up areas postcodes only")
notes <- NULL

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_quint(data = x, value_type = value_type_short)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
area_comp <- plot_areas_quint(data = x, area_codes = rbwm_wards,
                                  value_type = value_type_short,
                                  show_ci = FALSE)
map <- map_quintile_indicator(data = x, shape_file = shp_lsoa, 
                              areas_to_map = rbwm_lsoas)

trend_plot <- paste0("No trend data available.")

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot, alt_text = trend_plot)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
# gotta make font size smaller as too much metadata
formatted_metadata <- fpar(ftext(metadata, prop = fp_text(font.size = 8)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = formatted_metadata)

```

```{r access_secondary_school, eval = incl_access_secondary_school}

slide_num <- slide_num + 1

# Metadata
ind_ID <- "Accsstscns"
ind_sex <- NULL
ind_age <- NULL
title <- paste0("Access to secondary school within 30 minutes by public transport or walking")
short_title <- "Access to secondary school"
context <- NULL
value_type <- "Proportion (%)"
value_type_short <- "%"
timeperiod <- NULL
original_geography <- "Postcode"
CI_level <- 0.95
benchmarking_method <- paste0("Wilson Score method (", CI_level * 100,"%)")
source <- "Department for Transport. Journey time statistics"
caveats <- NULL
notes <- "Service users able to access a secondary school within 30-minutes by public transport or walking"

x <- retrieve_indicator_data(master_df = dataset, indicator_ID = ind_ID, 
                             factor_list = factor_list)

latest_value <- plot_latest_value_rag(data = x, value_type = value_type)
latest_period <- paste0("Latest time period: ", max(x$Timeperiod))
area_comp <- plot_areas_comp(data = x, area_codes = rbwm_wards,
                             value_type = value_type, show_legend = FALSE)
map <- map_comp_indicator(data = x, shape_file = shp_lsoa,
                         areas_to_map = rbwm_lsoas)

trend_plot <- paste0("No trend data available.")

metadata <- text_metadata(title = title, context = context,
                          value_type = value_type, 
                          original_geography = original_geography, 
                          benchmarking_method = benchmarking_method,
                          source = source, caveats = caveats, notes = notes)

# Add slide
mydoc <- add_slide(mydoc, layout = "jlhws", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = short_title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "version"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "overview"), 
                 value = latest_value$plot, alt_text = latest_value$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "latest period"), 
                 value = latest_period, alt_text = latest_period)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "trend"), 
                 value = trend_plot, alt_text = trend_plot)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "compare areas"), 
                 value = area_comp$plot, alt_text = area_comp$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "map"), 
                 value = map$plot, alt_text = map$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "metadata"), 
                 value = metadata) 

```

``` {r finish.code}

outfile <- paste0("../output/RBWM_JHWBS_profile_", format(version_num, nsmall = 1), ".pptx")
print(mydoc, target = outfile)

t2 <- Sys.time()
duration <- difftime(t2, t1, units = "secs")
# status.log(paste("This took", duration, "seconds"))

```
