---
params:
  save_params_as: "params.Rds"

  # Introduction
  title: TRUE

  # People and place
  title_people_and_place: TRUE
  population: TRUE
  deprivation: TRUE

  # Best start in life
  title_best_start_in_life: TRUE
  obesity_reception: TRUE
  
  # Living well
  title_living_well: TRUE
  
  # Healthy ageing
  title_health_ageing: TRUE
  
  # Healthy places
  title_healthy_place: TRUE
---

```{r settings}

# set working directory
setwd(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/projects_git/JHWBS-profiles/R"))

# Save dataset
save_dataset <- TRUE

# Do you want to load the lookup and data files
load_files <- TRUE

ward_name <- NULL
ward_code <- NULL

# Version number
version_num <- 0.3

# Load required packages
library(officer)
library(phiTools)
library(sf)

# Warning options
options(warn = 1) ## Show warnings as they occur, useful for finding and dealing with them.
options(scipen = 999) # Turn scientific notion off

# System time
t1 <- Sys.time()

# ---- PowerPoint template ----

# Open connection to pptx file
mydoc <- read_pptx(path = paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/References/Templates/RBWM-PHI-profiles-template.pptx"))

# slide number
slide_num <- 0

copyright <- paste0("Version ", format(version_num, nsmall = 1), " \uA9 RBWM Public Health Team, ", format(Sys.Date(), "%d/%m/%Y"))

## Save the parameters in case we want to use them in a script
save_params_as <- params$save_params_as
saveRDS(params, file = save_params_as)

report_params <- params

## Choose which slides to include

# Introduction
incl_title <- report_params$title

# People and place
incl_title_people_and_place<- report_params$title_people_and_place
incl_population <- report_params$population
incl_deprivation <- report_params$deprivation
incl_obesity_reception <- report_params$obesity_reception

# Best start in life
incl_title_best_start_in_life <- report_params$title_best_start_in_life

# Living well
incl_title_living_well <- report_params$title_living_well

# Healthy ageing
incl_title_health_ageing <- report_params$title_health_ageing

# Healthy place
incl_title_healthy_place <- report_params$title_healthy_place


# Create empty data frame for summary table
summary <- data.frame(indicator = character(), 
                      comparison = character(), 
                      slide = numeric(), stringsAsFactors = FALSE) 

# Create empty data frame for dataset
dataset <- data.frame()

#---- Data ----
rbwm_code <- "E06000040"

# england and wales LSOA to ward to las
lsoa_ward_lad <- read.csv(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/References/Geography/ONS Open Geography Portal/Lookups/LSOA to Ward to LAD/LSOA_(2021)_to_Electoral_Ward_(2024)_to_LAD_(2024)_Best_Fit_Lookup_in_EW.csv"))

# RBWM lsoas
i <- lsoa_ward_lad$LAD24CD == rbwm_code
rbwm_lsoas <- lsoa_ward_lad$LSOA21CD[i]

# ONS LA pop estimates
pop_la <- readRDS(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/Datasets/ONS/nomis/Population/Population estimates/Local authority/processed data/ons-la-pop.Rds"))

# ONS lsoa pop estimates
pop_lsoa <- readRDS(paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/Datasets/ONS/nomis/Population/Population estimates/lsoa/processed data/ons-lsoa-pop.Rds"))

# LSOA deprivation
dep <- data_deprivation_pop(population = pop_lsoa)

#### Fingertips data ####
fingertips_msoa <- data_fingertips_msoa()

#---- Shape files ----
#### RBWM LSOAs ####
shp_lsoa <- data_shape_lsoa()

```

```{r title, eval = incl_title}

slide_num <- slide_num + 1

# Add slide
mydoc <- add_slide(mydoc, layout = "title logo", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = paste0("The Royal Borough of Windsor \u0026 Maidenhead Health and Wellbeing profile"))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "subtitle"),
                 value = paste0("Public Health ", format(Sys.Date(), "%d/%m/%Y")))
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r title_people_and_place, eval = incl_title_people_and_place}

# ---- People and place ----
slide_num <- slide_num + 1
theme <- NULL
title <- paste0("People and place")
short_title <- NULL


# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r population, eval = incl_population}

slide_num <- slide_num + 1
theme <- NULL
title <- paste0("Population")
short_title <- NULL

# Outputs
pop_pyramid <- plot_pop_pyramid(data = pop_la)
pop_comp <- plot_pop_area_comp_eng(data = pop_la)

# Add slide
mydoc <- add_slide(mydoc, layout = "two content", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = copyright)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content left"), 
                 value = pop_pyramid$plot, alt_text = pop_pyramid$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content right"), 
                 value = pop_comp$plot, alt_text = pop_comp$alt_text)

```

```{r deprivation, eval = incl_deprivation}

slide_num <- slide_num + 1
theme <- NULL
title <- paste0("Deprivation")
short_title <- NULL

# Outputs
pop_dep_bar_plot <- plot_dep_pop(data = dep)
dep_map <- map_deprivation(deprivation_data = dep, lsoa_shape = shp_lsoa,
                           lsoas_to_plot = rbwm_lsoas)

# Add slide
mydoc <- add_slide(mydoc, layout = "two content", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = copyright)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content left"), 
                 value = pop_dep_bar_plot$plot, alt_text = pop_dep_bar_plot$alt_text)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "content right"), 
                 value = dep_map$ggplot, alt_text = dep_map$alt_text)

```

```{r title_best_start_in_life, eval = incl_title_best_start_in_life}

# ---- Best start in life ----
slide_num <- slide_num + 1
theme <- NULL
title <- paste0("Best start in life")
short_title <- NULL


# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r obesity_reception, eval = incl_obesity_reception}

slide_num <- slide_num + 1
theme <- "TH1"

# https://fingertips.phe.org.uk/profile/local-health/data#page/3/gid/1938133183/pat/402/par/E06000035/ati/8/are/E05002249/iid/93108/age/201/sex/4/cat/-1/ctp/-1/yrr/3/cid/4/tbm/1/page-options/car-do-0

# Metadata
ind_ID <- 93105
ind_sex <- "Persons"
ind_age <- "4-5 yrs"
title <- paste0("Reception: Prevalence of obesity, ", tolower(ind_sex), ", ", tolower(ind_age))
short_title <- "Reception: Prevalence of obesity"
additional_text <- "Obesity: including severe obesity.\n\n"
notes <- "\nNotes: Due to the impact of COVID-19 on the NCMP data collection, data was not published for the 2018/19-20/21 time period."

value_type <- "Proportion (%)"
value_type_short <- "%"
original_geography <- "MSOA"
CI_level <- 0.95
confidence_interval_method <- paste0("Wilson Score CI method (", CI_level * 100,"%)")
source <- paste0("Office for Health Improvement and Disparities. Fingertips. Indicator ID: ", ind_ID)
copyright <- "\nCopyright: NHS Digital."




```

```{r title_living_well, eval = incl_title_living_well}

# ---- Living well ----
slide_num <- slide_num + 1
theme <- NULL
title <- paste0("Living well")
short_title <- NULL


# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r title_health_ageing, eval = incl_title_health_ageing}

# ---- Healthy ageing ----
slide_num <- slide_num + 1
theme <- NULL
title <- paste0("Healthy ageing")
short_title <- NULL


# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

```{r title_healthy_place, eval = incl_title_healthy_place}

# ---- Healthy ageing ----
slide_num <- slide_num + 1
theme <- NULL
title <- paste0("Healthy place")
short_title <- NULL


# Add slide
mydoc <- add_slide(mydoc, layout = "title", master = "PHI profiles")
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "title"),
                 value = title)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "slide number"), 
                 value = slide_num)
mydoc <- ph_with(mydoc, location = ph_location_label(ph_label = "copyright"), 
                 value = paste0("Version ", format(version_num, nsmall = 1)))
  
```

``` {r finish.code}

outfile <- paste0("../output/RBWM-HWB-profile-", format(version_num, nsmall = 1), ".pptx")
print(mydoc, target = outfile)

# Save dataset
if(save_dataset == TRUE){
  saveRDS(dataset, paste0("C:/Users/", Sys.getenv("username"), "/OneDrive - Royal Borough of Windsor and Maidenhead/PHI - Data and Analytics/Datasets/Profiles/JHWBS profile/RBWM-JWHBS-data-", format(version_num, nsmall = 1),".Rds"))
}

t2 <- Sys.time()
duration <- difftime(t2, t1, units = "secs")
# status.log(paste("This took", duration, "seconds"))

```
